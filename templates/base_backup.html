<!DOCTYPE html>
{% block doc -%}
<html lang="en">
<head>
    {%- block head %}
        <script>
            function calculateSettingAsThemeString({ localStorageTheme, systemSettingDark }) {
                if (localStorageTheme !== null) {
                    return localStorageTheme;
                }
                if (systemSettingDark.matches) {
                    return "dark";
                }
                return "light";
            }
            function updateThemeOnHtmlEl({ theme }) {
              document.querySelector("html").setAttribute("data-theme", theme);
            }
            const localStorageTheme = localStorage.getItem("theme");
            const systemSettingDark = window.matchMedia("(prefers-color-scheme: dark)");
            let currentThemeSetting = calculateSettingAsThemeString({ localStorageTheme, systemSettingDark });
            updateThemeOnHtmlEl({ theme: currentThemeSetting });
        </script>
        <title>{% block title %}{{ title | default }}{% endblock title %}</title>
        {%- block metas %}
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <meta charset="utf-8">
            <meta http-equiv="content-type" content="text/html; charset=utf-8">
        {%- endblock metas %}
        {%- block styles %}
            <link rel="manifest" href="manifest.json">
            <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='styles.css') }}">
            <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.svg') }}" type="image/svg">
        {%- endblock styles %}
    {%- endblock head %}
</head>
{% block body %}
    {% block navbar %}
        <div class="navbar navbar-inverse mw-100" role="navigation">
            <div class="container-fluid">
                <div class="navbar-header">
                    <button
                        type="button"
                        class="navbar-brand btn-nav"
                        data-theme-toggle
                        aria-label="üåû">
                        üåû
                    </button>
                    <a class="navbar-brand" href="/">Bible Study Hub</a>
                </div>
                <div class="navbar-collapse collapse">
                    <ul class="nav navbar-nav">
                        <li><a href="/">üìñ Read</a></li>
                        <li><a href="/search">üîç Search</a></li>
                        <li><a href="/grid">üìä Overview</a></li>
                        {% if current_user.is_authenticated %}
                            <li><a href="{{ url_for('study.notes') }}">üìù Notes</a></li>
                            <li><a href="{{ url_for('study.bookmarks') }}">üîñ Bookmarks</a></li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle">üìö Study <b class="caret"></b></a>
                                <div class="dropdown-menu">
                                    <a href="{{ url_for('study.study_guides') }}" class="dropdown-item">üìñ Study Guides</a>
                                    <a href="{{ url_for('study.word_studies') }}" class="dropdown-item">üî§ Word Studies</a>
                                    <div class="divider"></div>
                                    <a href="{{ url_for('study.create_study_guide') }}" class="dropdown-item">‚ûï New Study Guide</a>
                                    <a href="{{ url_for('study.create_word_study') }}" class="dropdown-item">üî§ New Word Study</a>
                                </div>
                            </li>
                        {% endif %}
                    </ul>
                    <ul class="nav navbar-nav navbar-right">
                        {% if current_user.is_authenticated %}
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle">üë§ {{ current_user.username }} <b class="caret"></b></a>
                                <div class="dropdown-menu">
                                    <a href="{{ url_for('auth.profile') }}" class="dropdown-item">‚öôÔ∏è Profile & Settings</a>
                                    <a href="{{ url_for('study.add_note') }}" class="dropdown-item">üìù Quick Note</a>
                                    <div class="divider"></div>
                                    <a href="/copyright" class="dropdown-item">üìÑ Copyright Info</a>
                                    <div class="divider"></div>
                                    <a href="{{ url_for('auth.logout') }}" class="dropdown-item">üö™ Logout</a>
                                </div>
                            </li>
                        {% else %}
                            <li><a href="/copyright">üìÑ Info</a></li>
                            <li><a href="{{ url_for('auth.login') }}">üîë Login</a></li>
                            <li><a href="{{ url_for('auth.register') }}">üìù Register</a></li>
                        {% endif %}
                    </ul>
                </div>
            </div>
        </div>
    {% endblock navbar %}
    
    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="container mt-3">
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    {% block main_content %}
    <div class="container">
        {% block content %}
        {% endblock content %}
    </div>
    {% endblock main_content %}

    {% block nav_script %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(function() {
                // Theme toggle functionality
                const button = document.querySelector("[data-theme-toggle]");
                if (button) {
                    button.addEventListener("click", () => {
                        const currentTheme = document.querySelector("html").getAttribute("data-theme");
                        const newTheme = currentTheme === "dark" ? "light" : "dark";
                        
                        localStorage.setItem("theme", newTheme);
                        updateThemeOnHtmlEl({ theme: newTheme });
                        
                        // Update button icon
                        button.textContent = newTheme === "dark" ? "üåô" : "üåû";
                        button.setAttribute("aria-label", newTheme === "dark" ? "üåô" : "üåû");
                    });
                }

                // Dropdown functionality
                document.querySelectorAll('.dropdown-toggle').forEach(function(toggle) {
                    toggle.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        const dropdown = this.closest('.dropdown');
                        const menu = dropdown.querySelector('.dropdown-menu');
                        
                        if (menu) {
                            const isVisible = menu.style.display === 'block';
                            
                            if (isVisible) {
                                menu.style.display = 'none';
                                console.log('HIDING menu');
                            } else {
                                // Hide all other menus first
                                document.querySelectorAll('.dropdown-menu').forEach(function(m) {
                                    m.style.display = 'none';
                                });
                                
                                menu.style.display = 'block';
                                menu.style.position = 'absolute';
                                menu.style.top = '100%';
                                menu.style.left = '0';
                                menu.style.zIndex = '9999';
                                console.log('SHOWING menu');
                            }
                        } else {
                            console.log('NO MENU FOUND!');
                        }
                    });
                });
                
                // Click outside to close
                document.addEventListener('click', function(e) {
                    if (!e.target.closest('.dropdown')) {
                        document.querySelectorAll('.dropdown-menu').forEach(function(menu) {
                            menu.style.display = 'none';
                        });
                    }
                });
                
            }, 500); // Wait 500ms for everything to load
        });
    </script>
    {% endblock nav_script %}
{% endblock body %}
</html>
{% endblock doc -%}